<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <meta name="msapplication-TileColor" content="#da532c">
    <link rel="stylesheet" href="styles/icomoon.css">
    <link rel="stylesheet" href="https://necolas.github.io/normalize.css/8.0.1/normalize.css">
    <link rel="stylesheet" href="styles/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
    <script src="libraries/FileSaver-js/FileSaver.js"></script>

    <title>BetterCensorship</title>
</head>
<body>
<div class="pageContainer d-flex align-items-center justify-content-center">
    <div id="decensorUpload" class="d-flex flex-column align-items-center" onclick="loadPage()">
        <span class="icon-folder-upload"></span>
        <span class="uploadText">Open File</span>
    </div>
    <div id="canvasContainer">
        <canvas id="drawingBoard"></canvas>

        <div class="keyContainer">
            <label for="key">Password:&nbsp</label>
            <input type="text" id="key" name="key">
        </div>
        <span id="keyHelpText">
                (Leave empty if none)
            </span>
        <span id="decensorButton" onclick="decensor();">
            Decensor!
        </span>
    </div>
</div>

<div class="error" id="notAnImage" title="Error">File is not an Image. Press OK to reload the page</div>
<div class="error" id="notBetterCensorshipImage" title="Error">Image not generated by BetterCensorship. Press OK to reload the page</div>
<div class="error" id="passwordIncorrect" title="Error">Password Incorrect. Press OK to reload the page</div>
<div class="error" id="dataPayloadCorrupted" title="Error">Data Payload Corrupted. Press OK to reload the page</div>

<script>
    let _URL = window.URL || window.webkitURL;
    let display = $("#canvasContainer").css("display");
    $("#canvasContainer").css("display", "none");
    let decensor;

    let fileInput = $("<input type=file>");
    let notAnImageDialog = $("#notAnImage");
    let notBCImageDialog = $("#notBetterCensorshipImage");
    let passwordIncorrectDialog = $("#passwordIncorrect");
    let dataPayloadCorruptedDialog = $("#dataPayloadCorrupted");

    let dialogOptions = {
        autoOpen: false,
        modal: true,
        dialogClass: "no-close",
        minWidth: 250,
        buttons: [
            {
                text: "OK",
                click: function () {
                    window.location.reload();
                }
            }
        ]
    }

    notAnImageDialog.dialog(dialogOptions);
    notBCImageDialog.dialog(dialogOptions);
    passwordIncorrectDialog.dialog(dialogOptions);
    dataPayloadCorruptedDialog.dialog(dialogOptions);

    let loadPage = function () {
        fileInput.click();
        return false;
    }
    fileInput.change(function (e) {
        let file;
        if ((file = this.files[0])) {
            let img = new Image();
            let canvas = $("#drawingBoard")[0];
            let ctx = canvas.getContext("2d");
            img.onload = function () {
                $("#canvasContainer").css("display", display)
                $("#decensorUpload").attr('style', 'display: none !important');
                canvas.height = this.height;
                canvas.width = this.width;
                // TODO IMPLEMENT CSS SCALING
                if (this.height > (document.documentElement.clientHeight/1.5)) {
                    let scalar = this.height/(document.documentElement.clientHeight/1.5);
                    $("#drawingBoard").css("height", `${this.height/scalar}px`)
                    $("#drawingBoard").css("width", `${this.width/scalar}px`)
                }
                ctx.drawImage(img, 0, 0);

                decensor = function () {
                    let reader = new FileReader();
                    let payload, view, list, iend, encryption, version, decrypted;
                    reader.onload = function () {
                        try {
                            view = new Uint8Array(reader.result);
                            list = metadata.splitChunk(Uint8ToString(view));
                            iend = list.pop();
                            payload = list.pop();
                            encryption = list.pop();
                            version = list.pop();
                            //Might error at the strict type check
                            if ((version.data.split("Version\u0000").join("")).split(" ")[0] !== "BetterCensor") {
                                throw new Error("Version Mismatch");
                            }
                            try {
                                let key = $("#key").text();
                                payload = payload.data.split("Payload\u0000").join("")
                                decrypted = CryptoJS.AES.decrypt(payload, key).toString(CryptoJS.enc.Utf8)
                                try {
                                    let decryptedPayload = JSON.parse(decrypted);
                                    let canvasData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                                    decryptedPayload.items.forEach(chunk=>{
                                        for (let i = 0; i<100; i++) {
                                            canvasData.data[(chunk.chunkIndex+i)] = chunk.array[i];
                                        }
                                    })
                                    ctx.putImageData(canvasData, 0, 0)
                                    $("#decensorButton").text("Download!").click(function (){
                                        let link = document.createElement('a');
                                        link.download = 'decensored.png';
                                        link.href = canvas.toDataURL()
                                        link.click();
                                    })
                                } catch {
                                    dataPayloadCorruptedDialog.dialog("open");
                                    $("body").css('background-color', "grey");
                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                }
                            } catch {
                                passwordIncorrectDialog.dialog("open");
                                $("body").css('background-color', "grey");
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                            }
                        } catch {
                            notBCImageDialog.dialog("open");
                            $("body").css('background-color', "grey");
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                    }
                    reader.readAsArrayBuffer(file);
                }
            }
            img.onerror = function () {
                notAnImageDialog.dialog("open");
                $("body").css('background-color', "grey");
            }
            img.src = _URL.createObjectURL(file);

        }
    })

    $("#imageDecode").change(function (e) {
        //TODO ADD ERROR CHECKING: Mainly, that it is an image, that it is one of our images, that the password is correct, that the data payload is correct.
        let file, canvas, ctx, img, imagedata, key;
        if ((file = this.files[0])) {
            img = new Image();
            canvas = $("#drawingBoard")[0];
            ctx = canvas.getContext('2d');

            img.onload = function () {
                canvas.height = this.height;
                canvas.width = this.width;
                ctx.drawImage(img, 0, 0);
                let reader = new FileReader();
                reader.onload = function (){
                    let view = new Uint8Array(reader.result);
                    let list = metadata.splitChunk(Uint8ToString(view));
                    console.log(list);
                    let iend = list.pop();
                    let payload = list.pop();
                    let encryption = list.pop();
                    if (encryption[-1] == "s") {
                        console.log("Encrypted: True")
                    } else {
                        console.log("Encrypted: False")
                        key = "";
                    }
                    payload = payload.data.split("Payload\u0000").join("")
                    let decrypted = CryptoJS.AES.decrypt(payload, key).toString(CryptoJS.enc.Utf8)
                    let decryptedPayload = JSON.parse(decrypted)
                    let canvasData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                    decryptedPayload.items.forEach(chunk=>{
                        let clampedArray = Object.keys(chunk.array).map(key=>chunk.array[key])
                        console.log(clampedArray)
                        for (let i = 0; i<100; i++) {
                            canvasData.data[(chunk.chunkIndex+i)] = chunk.array[i];
                        }
                        // Array.prototype.splice.apply(canvasData.data, [chunk.chunkIndex, clampedArray.length].concat(clampedArray))
                    })
                    ctx.putImageData(canvasData, 0, 0)

                }
                reader.readAsArrayBuffer(file);
            }

            img.src = _URL.createObjectURL(file);
        }
    })
</script>

<script>
    //Foreign Code
    let metadata = {}
    metadata.PNG_SIG = String.fromCharCode(0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a);

    function Uint8ToString(u8a){
        var CHUNK_SZ = 0x8000;
        var c = [];
        for (var i=0; i < u8a.length; i+=CHUNK_SZ) {
            c.push(String.fromCharCode.apply(null, u8a.subarray(i, i+CHUNK_SZ)));
        }
        return c.join("");
    }

    metadata.isPNG = function (s) {
        var sig = s.substr(0, 8);
        return (sig == metadata.PNG_SIG);
    };

    metadata.splitChunk= function (s) {
        // read signature
        var sig = s.substr(0, 8);
        if (!metadata.isPNG(sig)) return false;
        s = s.substr(8); // chomp sig
        var chunklist = [];
        // read chunk list
        while (s != '') {
            var chunk = {};
            // read chunk size
            var size = stoi(s.substr(0, 4));
            if (size < 0) {
                // If the size is negative, the data is likely corrupt, but we'll let
                // the caller decide if any of the returned chunks are usable.
                // We'll move forward in the file with the minimum chunk length (12 bytes).
                size = 0;
            }
            var buf = s.substr(0, size + 12);
            s = s.substr(size + 12); // delete this chunk
            // read chunk data
            chunk.size = size;
            chunk.type = buf.substr(4, 4);
            chunk.data = buf.substr(8, size);
            chunk.crc  = stoi(buf.substr(8 + size, 4));
            // add chunk
            chunklist.push(chunk);
        }
        return chunklist;
    };
    metadata.stoi = stoi;
    function stoi(s) {
        var v = 0;
        for (var i = 0; i < s.length; i++) {
            var c = s.charCodeAt(i);
            v = (v << 8) | (c & 0xFF);
        }
        return v;
    }
</script>
</body>
</html>